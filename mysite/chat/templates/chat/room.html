{% extends 'chat/index.html' %}

{% block title %}Welcome | {% endblock %}

{% block content %}
<div class="container">
  <div class="hide-scrollbar flex-1 mb-3" id="chat-body">
    <div class="chat-body-inner">
      {% for m in messages %}
        <div class="message {% if m.engagement.name != 'Machine'%} message-out {%endif%}">
          <p class="username">{{ m.engagement.name }}</p>
          <div class="message-inner">
            <div class="message-body">
              <div class="message-content">
                <div class="message-text">
                  <p class="mb-0 text-capitalize">{{ m.content }}</p>
                  {% if m.entity == "yes-no" %}
                    {% if not m.answer %}
                      <div class="pt-4 position-relative" id="{{m.id}}">
                        <input
                          type="radio"
                          class="btn-check"
                          id="{{m.id}}-yes"
                          name="yes-no"
                          value="yes"
                          onchange="answerYesNo({{m.id}}, 'yes', {{m.entity}})"
                        >
                        <label class="btn btn-primary" for="{{m.id}}-yes">Yes</label>
                
                        <input
                          type="radio"
                          class="btn-check"
                          id="{{m.id}}-no"
                          name="yes-no"
                          value="no"
                          onchange="answerYesNo({{m.id}}, 'no', {{m.entity}})"
                        >
                        <label class="btn mx-2 btn-danger" for="{{m.id}}-no">No</label>
                      </div>
                    {% endif %}
                  {% endif %}

                  {% if m.entity == "date-time" %}
                    {% if not m.answer %}
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="form-chat">
    <div class="input-group mb-3">
      <textarea id="chat-message-input" class="form-control p-2" placeholder="Type your message..."></textarea>
    </div>

    <div class="entities-type mb-2">
      {% for entity in default_entities_types %}
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="radio"
            name="entities-type"
            value="{{entity.id}}"
            id="{{entity.id}}"
            {% if entity.id == 'text' %} checked{% endif %}
          />
          <label class="form-check-label" for="{{entity.id}}">
            {{entity.label}}
          </label>
        </div>
      {% endfor %}
    </div>

    <input type="button" class="btn btn-primary" value="Send" id="chat-message-submit"/>
    <input type="hidden" value="{{engagement_id|default:''}}" id="chat-engagement-input"/>
  </div>
</div>
{{ room.uuid|json_script:"room_id" }} {% endblock %}
{% block script %}
<script>
  const roomId = JSON.parse(document.getElementById('room_id').textContent);

  const chatSocket = new WebSocket(
    `ws://${window.location.host}/ws/chat/${roomId}/`
  );

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    if (data.message) {
      renderMessage(data)

      scrollToBottom();
    } else {
      alert('The message was empty!');
    }
  };

  chatSocket.onclose = function (e) {
    console.error('Chat socket closed unexpectedly');
  };

  document.querySelector('#chat-message-input').focus();
  document.querySelector('#chat-message-input').onkeyup = function (e) {
    if (e.keyCode === 13) {
      document.querySelector('#chat-message-submit').click();
    }
  };

  document.querySelector('#chat-message-submit').onclick = function (e) {
    const message = $('#chat-message-input').val(),
          engagementId= $('#chat-engagement-input').val(),
          entity = $('input[name="entities-type"]:checked').val(),
          params = {message, roomId, engagementId, entity}

    sendData(params)
  };

  const renderMessage = (data) => {
    switch(data.entity) {
      case "yes-no":
        document.querySelector('#chat-body').innerHTML += yesNoQuestionBox(data);

        // Hide the yes/no buttons
        if (data.answer) {
          $(`div[id=${data.question_id}]`).css({"display": "none"})
        } else {
          // Add event for yes/no question
          element = $(`div[id=${data.message_id}]`)
          element.find(`input[type=radio][name=yes-no]`).on('change', function() {
            value = $('input[name="yes-no"]:checked').val()
            const message = value,
                  room_id = data.room_id,
                  question_id = data.message_id
                  engagementId= $('#chat-engagement-input').val(),
                  entity = data.entity,
                  answer = value,
                  params = {message, roomId, engagementId, entity, answer, question_id};
            sendData(params);
          })
        }

        break;

      case "date-time":
        document.querySelector('#chat-body').innerHTML += dateTimePickerBox(data);

        // Hide the date picker buttons
        if (data.answer) {
          $(`div[id=${data.question_id}]`).css({"display": "none"});

        } else {
          // Add event for date time picker
          element = $(`div[id=${data.message_id}]`);

          $(`#${data.message_id}-datepicker`).datepicker({
            container: element,
            format: 'yyyy-mm-dd',
            orientation: 'bottom auto',
            autoclose: false,
          }).on(
            'changeDate',
            (event) => {
              $(`#${data.message_id}-date`).val(event.format());
            }
          );
          
          $(`#${data.message_id}-next`).on('click', () => {
            const dateValue = $(`#${data.message_id}-date`).val();
            const timeValue = $(`#${data.message_id}-time`).val();

            if (dateValue && timeValue) {
              value = `${dateValue} ${convertTime(timeValue)}`;

              const message = value,
                room_id = data.room_id,
                question_id = data.message_id
                engagementId= $('#chat-engagement-input').val(),
                entity = data.entity,
                answer = value,
                params = {message, roomId, engagementId, entity, answer, question_id};

              sendData(params);
            }
          });
        }

        break;

      default:
        document.querySelector('#chat-body').innerHTML += textMessageBox(data);
        return;
    }
  }

  function answerYesNo(id, value, entity) {
    const message = value,
      room_id = room_id,
      question_id = id
      engagementId= $('#chat-engagement-input').val(),
      answer = value,
      params = {message, roomId, engagementId, entity, answer, question_id};

    sendData(params);
  }


  const sendData = (params = {}) => {
    const paramsToString = JSON.stringify({
      message: params.message,
      room_id: params.roomId,
      engagement_id: params.engagementId,
      entity: params.entity,
      ...(params.answer ? {answer: params.answer} : {}),
      ...(params.question_id ? {question_id: params.question_id} : {}),
    })

    chatSocket.send(paramsToString);
    $('#chat-message-input').val("");
  }

  function scrollToBottom() {
    let objDiv = document.getElementById("chat-body");
    objDiv.scrollTo({top: objDiv.scrollHeight, behavior: 'smooth'});
  }

  scrollToBottom();
</script>
{% endblock %}
